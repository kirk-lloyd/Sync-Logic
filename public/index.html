<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Sync Logic Dashboard</title>
    
    <!-- Load FontAwesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Load Shopify App Bridge -->
    <script type="module" src="https://unpkg.com/@shopify/app-bridge@latest"></script>
    
    <!-- Custom Stylesheets -->
    <link rel="stylesheet" href="/static/master.css">
    <link rel="stylesheet" href="/static/navigation.css">
</head>
<body>
    <!-- Navigation Bar -->
    <div id="navigation"></div>

    <!-- Home Section -->
    <div id="home" class="content-section">
        <h1>Home</h1>
        <p>Welcome to the Stock Sync Logic Dashboard home page. Here you can manage your store's products, bundles, and sync status.</p>

        <!-- Summary Grid -->
        <div class="summary">
            <div class="summary-item">
                <h3>Last Sync Time</h3>
                <p id="last-sync-time">Not Available</p>
            </div>
            <div class="summary-item">
                <h3>Sync Status</h3>
                <p id="sync-status">Not Available</p>
            </div>
            <div class="summary-item">
                <h3>Total Synced Products</h3>
                <p id="total-products">0</p>
            </div>
            <div class="summary-item">
                <h3>Total Bundles</h3>
                <p id="total-bundles">0</p>
            </div>
            <div class="summary-item">
                <h3>Next Scheduled Sync</h3>
                <p id="next-sync">Not Scheduled</p>
            </div>
        </div>

        <button class="sync-button" onclick="triggerManualSync()">Manual Sync</button>
    </div>

    <!-- Products Section -->
    <div id="products" class="content-section" style="display: none;">
        <h1>Products</h1>
        <p>Manage your store's products. Choose a product to be the "Sync Master" and link products it will control for stock synchronization.</p>

        <!-- Search Bar -->
        <input type="text" id="product-search" placeholder="Search products..." onkeyup="filterProducts()">

        <!-- Products Table -->
        <table id="products-table">
            <thead>
                <tr>
                    <th onclick="sortTable(0)">Product Name</th>
                    <th onclick="sortTable(1)">SKU</th>
                    <th onclick="sortTable(2)">Inventory</th>
                    <th onclick="sortTable(3)">Product Type</th>
                    <th onclick="sortTable(4)">Vendor</th>
                    <th>Stock Master</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="products-table-body">
                <!-- Product rows will be dynamically inserted here -->
            </tbody>
        </table>
    </div>

<script>
    // Shopify App Bridge Setup
    document.addEventListener("DOMContentLoaded", async function() {
        try {
            console.log("Initializing Shopify App Bridge...");
            const AppBridge = window['app-bridge'];
            const createApp = AppBridge.default;
            const actions = AppBridge.actions;

            const apiKey = "{{SHOPIFY_API_KEY}}";  // Replace this with actual apiKey injected from server-side
            const shopOrigin = new URLSearchParams(location.search).get("shop");

            if (!apiKey || !shopOrigin) {
                console.error("Missing apiKey or shopOrigin");
                return;
            }

            const app = createApp({
                apiKey: apiKey,
                shopOrigin: shopOrigin,
                forceRedirect: true,
            });

            console.log("Shopify App Bridge initialized successfully.");

            const { NavigationMenu } = actions;

            // Set up App Bridge Navigation Menu
            NavigationMenu.create(app, {
                items: [
                    { label: 'Home', destination: `/?shop=${shopOrigin}` },
                    { label: 'Products', destination: `/products?shop=${shopOrigin}` },
                    { label: 'Bundles', destination: `/bundles?shop=${shopOrigin}` },
                ],
            });

            console.log("Navigation menu set up successfully.");

            // Fetch products data after initializing Shopify App Bridge
            await fetchProducts();

        } catch (error) {
            console.error("Error initializing Shopify App Bridge:", error);
        }
    });

async function fetchProducts() {
    try {
        const shopDomain = new URLSearchParams(location.search).get("shop");
        if (!shopDomain) {
            console.error('Missing shop domain in query parameters');
            return;
        }

        console.log('Fetching products for shop via GraphQL:', shopDomain);

        // GraphQL query to get product information
        const query = `
            {
                products(first: 50) {
                    edges {
                        node {
                            id
                            title
                            vendor
                            productType
                            variants(first: 1) {
                                edges {
                                    node {
                                        sku
                                        inventoryQuantity
                                    }
                                }
                            }
                        }
                    }
                }
            }
        `;

        // Making the request to the backend to execute the GraphQL query
        const response = await fetch(`/api/products/graphql?shop=${encodeURIComponent(shopDomain)}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Shop-Domain': shopDomain
            },
            body: JSON.stringify({ query })
        });

        // Log full response details
        console.log('Fetch response status:', response.status);
        console.log('Fetch response headers:', response.headers);

        if (!response.ok) {
            const responseText = await response.text();
            console.error(`Network response was not ok: ${response.status} - ${response.statusText}`);
            console.error('Response body:', responseText);
            throw new Error(`Network response was not ok: ${response.status} - ${response.statusText}`);
        }

        // Parsing JSON response
        const responseData = await response.json();
        if (responseData.errors) {
            console.error('GraphQL errors:', responseData.errors);
            throw new Error('Failed to fetch products due to GraphQL errors');
        }

        const products = responseData.data.products.edges.map(edge => {
            const product = edge.node;
            const variant = product.variants.edges[0]?.node || {};
            return {
                id: product.id,
                title: product.title,
                vendor: product.vendor,
                product_type: product.productType,
                sku: variant.sku || '-',
                inventory_quantity: variant.inventoryQuantity || 0
            };
        });

        console.log('Successfully fetched products via GraphQL:', products);
        populateProductsTable(products);
    } catch (error) {
        console.error('Error fetching products via GraphQL:', error);
    }
}

    function populateProductsTable(products) {
        const tableBody = document.getElementById('products-table-body');
        if (!tableBody) {
            console.error('Products table body element not found');
            return;
        }

        console.log('Populating products table with data...');
        tableBody.innerHTML = '';

        products.forEach(product => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${product.title}</td>
                <td>${product.sku ? product.sku : '-'}</td>
                <td>${product.inventory_quantity}</td>
                <td>${product.product_type}</td>
                <td>${product.vendor}</td>
                <td>
                    <input type="checkbox" class="stock-master-checkbox" data-product-id="${product.id}" ${product.isSyncMaster ? 'checked' : ''}>
                </td>
                <td class="action-buttons">
                    <button class="link-products-btn" onclick="linkProducts('${product.id}')">Link Products</button>
                </td>
            `;
            tableBody.appendChild(row);
        });

        // Add event listener for each "Stock Master" checkbox
        document.querySelectorAll('.stock-master-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const productId = this.dataset.productId;
                const isSyncMaster = this.checked;
                updateProductMetafield(productId, isSyncMaster);
            });
        });

        console.log('Products table populated successfully.');
    }

    async function updateProductMetafield(productId, isSyncMaster) {
        try {
            const shopDomain = new URLSearchParams(location.search).get("shop");
            if (!shopDomain) {
                console.error('Missing shop domain in query parameters');
                return;
            }

            console.log(`Updating metafield for product ${productId} to isSyncMaster: ${isSyncMaster}`);

            const response = await fetch(`/api/products/${productId}/metafields`, {
                method: 'PUT',
                headers: { 
                    'Content-Type': 'application/json',
                    'shop-domain': shopDomain 
                },
                body: JSON.stringify({ isSyncMaster })
            });

            if (!response.ok) {
                throw new Error(`Failed to update metafield: ${response.statusText}`);
            }

            console.log(`Successfully updated metafield for product ${productId}`);
        } catch (error) {
            console.error(`Error updating metafield for product ${productId}:`, error);
        }
    }

    function filterProducts() {
        const searchInput = document.getElementById('product-search').value.toUpperCase();
        const table = document.getElementById('products-table');
        if (!table) {
            console.error('Products table element not found');
            return;
        }

        const tr = table.getElementsByTagName('tr');

        for (let i = 1; i < tr.length; i++) {
            const td = tr[i].getElementsByTagName('td')[0];
            if (td) {
                const txtValue = td.textContent || td.innerText;
                tr[i].style.display = txtValue.toUpperCase().indexOf(searchInput) > -1 ? '' : 'none';
            }
        }
    }

    function triggerManualSync() {
        console.log('Manual sync triggered!');
        alert('Manual sync triggered!');
    }

    function linkProducts(productId) {
        console.log(`Linking products for product ${productId}`);
        alert(`Link products for product ${productId}`);
    }
</script>

<script src="/static/navigation.js" defer></script>
</body>
</html>
